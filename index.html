<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absence Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Absence">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.10);
      --txt: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.14);
      --accent: #7dd3fc;
      --danger: #fb7185;
      --ok: #34d399;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 800px at 30% 10%, rgba(125,211,252,0.22), transparent 55%),
                  radial-gradient(900px 700px at 90% 40%, rgba(52,211,153,0.14), transparent 55%),
                  radial-gradient(800px 600px at 30% 95%, rgba(251,113,133,0.10), transparent 55%),
                  var(--bg);
      color: var(--txt);
      min-height: 100dvh;
    }

    .container{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px;
      padding-bottom: 28px;
    }

    header{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 14px;
    }

    .app-title{
      font-size: clamp(22px, 4vw, 34px);
      letter-spacing: 0.5px;
      font-weight: 800;
      text-transform: uppercase;
      line-height: 1.15;
    }
    .app-subtitle{
      color: var(--muted);
      font-size: clamp(13px, 2.2vw, 15px);
      line-height: 1.4;
    }

    .tabs{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 14px 0 10px;
    }

    .tab{
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--txt);
      padding: 12px 10px;
      border-radius: 999px;
      cursor: pointer;
      text-align: center;
      font-weight: 800;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select: none;
    }
    .tab:active{ transform: scale(0.99); }
    .tab.active{
      background: rgba(125,211,252,0.18);
      border-color: rgba(125,211,252,0.45);
      box-shadow: 0 0 0 6px rgba(125,211,252,0.08);
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .section-title{
      font-size: clamp(18px, 3vw, 26px);
      text-transform: uppercase;
      letter-spacing: 0.7px;
      font-weight: 900;
      margin: 0 0 4px;
    }
    .section-subtitle{
      margin: 0 0 14px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }

    /* Backup bar */
    .tools{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 14px;
    }
    .tools .hint{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
      flex: 1 1 240px;
      min-width: 0;
    }

    .form-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .field{
      display: grid;
      gap: 6px;
      min-width: 0;
    }
    label{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      color: var(--muted);
      font-weight: 800;
    }
    input, select, textarea{
      width: 100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.05);
      color: var(--txt);
      outline: none;
      font-size: 15px;
    }
    textarea{ min-height: 86px; resize: vertical; }

    /* FIX: na małym ekranie jedno pod drugim */
    .row{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items: start;
    }

    .divider{
      border-top: 1px solid var(--line);
      margin: 10px 0 6px;
      opacity: 0.9;
    }

    .actions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .btn{
      border: 1px solid var(--line);
      background: var(--card2);
      color: var(--txt);
      padding: 11px 14px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-size: 12px;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(0.99); }
    .btn.primary{
      background: rgba(52,211,153,0.16);
      border-color: rgba(52,211,153,0.40);
    }
    .btn.danger{
      background: rgba(251,113,133,0.14);
      border-color: rgba(251,113,133,0.35);
    }
    .btn.accent{
      background: rgba(125,211,252,0.14);
      border-color: rgba(125,211,252,0.35);
    }

    .summary{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 14px;
    }
    .pill{
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }
    .pill strong{
      font-size: 12px;
      letter-spacing: 0.7px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 800;
    }
    .pill span{
      font-weight: 950;
      letter-spacing: 0.3px;
      font-size: 15px;
      white-space: nowrap;
    }
    .pill .good{ color: var(--ok); }
    .pill .bad{ color: var(--danger); }
    .pill .accent{ color: var(--accent); }

    .list{
      margin-top: 14px;
      border-top: 1px solid var(--line);
      padding-top: 14px;
      display: grid;
      gap: 10px;
    }

    .item{
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 6px;
      min-width: 0;
    }
    .item-top{
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }
    .item-title{
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      font-size: 13px;
    }
    .item-meta{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      overflow-wrap: anywhere;
    }
    .item-badge{
      font-weight: 950;
      font-size: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      padding: 6px 10px;
      border-radius: 999px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .item-actions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .mini{
      padding: 9px 10px;
      font-size: 11px;
      border-radius: 12px;
    }

    @media (min-width: 560px){
      .row{ grid-template-columns: 1fr 1fr; }
      .summary{ grid-template-columns: 1fr 1fr 1fr; }
      .tabs{ gap: 12px; }
      .tab{ font-size: 14px; padding: 12px 12px; }
    }

    .hidden{ display: none !important; }
    .footnote{
      margin-top: 14px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="app-title">Absence Tracker</div>
      <div class="app-subtitle">Dane zapisują się lokalnie. Zrób backup (Export) – na iOS system może czyścić storage przy małej ilości miejsca.</div>

      <div class="tabs" role="tablist" aria-label="Menu">
        <button class="tab active" data-tab="holidays" role="tab" aria-selected="true">Holidays</button>
        <button class="tab" data-tab="sickness" role="tab" aria-selected="false">Sickness</button>
        <button class="tab" data-tab="childcare" role="tab" aria-selected="false">Child care absence</button>
      </div>

      <!-- Export/Import -->
      <div class="tools">
        <button class="btn accent" id="export-json">Export JSON</button>
        <button class="btn accent" id="import-json">Import JSON</button>
        <button class="btn danger" id="reset-all">Reset ALL</button>
        <div class="hint">
          Export pobiera plik z danymi. Import nadpisuje aktualne dane. (Dobre jako backup na iOS.)
        </div>
        <input id="import-file" type="file" accept="application/json,.json" class="hidden">
      </div>
    </header>

    <!-- HOLIDAYS -->
    <section id="panel-holidays" class="card" role="tabpanel">
      <h2 class="section-title">Holidays</h2>
      <p class="section-subtitle">
        Dodaj pojedynczy dzień lub zakres (od–do). Full day = 1, Half day = 0.5. Wpisy mają kolejne ID.
      </p>

      <div class="form-grid">
        <div class="row">
          <div class="field">
            <label for="h-date">Data (pojedynczy dzień)</label>
            <input id="h-date" type="date" />
          </div>
          <div class="field">
            <label for="h-type">Typ dnia</label>
            <select id="h-type">
              <option value="1">Full day</option>
              <option value="0.5">Half day</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="h-note">Notatka (opcjonalnie)</label>
          <input id="h-note" type="text" placeholder="np. urlop wypoczynkowy / wyjazd" />
        </div>

        <div class="actions">
          <button class="btn primary" id="h-add">Dodaj dzień</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label for="h-from">Zakres: od</label>
            <input id="h-from" type="date" />
          </div>
          <div class="field">
            <label for="h-to">Zakres: do</label>
            <input id="h-to" type="date" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="h-range-type">Typ dnia (dla całego zakresu)</label>
            <select id="h-range-type">
              <option value="1">Full day</option>
              <option value="0.5">Half day</option>
            </select>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn primary" id="h-add-range">Dodaj zakres</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn danger" id="h-clear">Wyczyść Holidays</button>
        </div>
      </div>

      <div class="summary">
        <div class="pill">
          <strong>Limit roczny</strong>
          <span class="accent" id="h-limit">25</span>
        </div>
        <div class="pill">
          <strong>Wzięte dni</strong>
          <span id="h-taken">0</span>
        </div>
        <div class="pill">
          <strong>Pozostało</strong>
          <span class="good" id="h-left">25</span>
        </div>
      </div>

      <div class="list" id="h-list"></div>

      <div class="footnote">
        Liczba_dni = 25 − wziete_dni (sumowane: Full=1, Half=0.5). Zakres dodaje wszystkie dni inkluzywnie (od i do).
      </div>
    </section>

    <!-- SICKNESS -->
    <section id="panel-sickness" class="card hidden" role="tabpanel">
      <h2 class="section-title">Sickness</h2>
      <p class="section-subtitle">
        Pojedynczy dzień lub zakres (od–do). Propozycja pól: zwolnienie, info do przełożonego, notatka.
      </p>

      <div class="form-grid">
        <div class="row">
          <div class="field">
            <label for="s-date">Data (pojedynczy dzień)</label>
            <input id="s-date" type="date" />
          </div>
          <div class="field">
            <label for="s-type">Typ dnia</label>
            <select id="s-type">
              <option value="1">Full day</option>
              <option value="0.5">Half day</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="s-cert">Zwolnienie lekarskie</label>
            <select id="s-cert">
              <option value="Nie">Nie</option>
              <option value="Tak">Tak</option>
            </select>
          </div>
          <div class="field">
            <label for="s-contact">Kontakt do przełożonego (opcjonalnie)</label>
            <input id="s-contact" type="text" placeholder="np. poinformowałem o 08:15" />
          </div>
        </div>

        <div class="field">
          <label for="s-note">Notatka (opcjonalnie)</label>
          <input id="s-note" type="text" placeholder="np. przeziębienie / wizyta u lekarza" />
        </div>

        <div class="actions">
          <button class="btn primary" id="s-add">Dodaj dzień</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label for="s-from">Zakres: od</label>
            <input id="s-from" type="date" />
          </div>
          <div class="field">
            <label for="s-to">Zakres: do</label>
            <input id="s-to" type="date" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="s-range-type">Typ dnia (dla całego zakresu)</label>
            <select id="s-range-type">
              <option value="1">Full day</option>
              <option value="0.5">Half day</option>
            </select>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn primary" id="s-add-range">Dodaj zakres</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn danger" id="s-clear">Wyczyść Sickness</button>
        </div>
      </div>

      <div class="summary">
        <div class="pill">
          <strong>Wpisów</strong>
          <span class="accent" id="s-count">0</span>
        </div>
        <div class="pill">
          <strong>Łącznie dni</strong>
          <span id="s-total">0</span>
        </div>
        <div class="pill">
          <strong>Ostatnia data</strong>
          <span id="s-last">—</span>
        </div>
      </div>

      <div class="list" id="s-list"></div>
    </section>

    <!-- CHILD CARE -->
    <section id="panel-childcare" class="card hidden" role="tabpanel">
      <h2 class="section-title">Child care absence</h2>
      <p class="section-subtitle">
        Pojedynczy dzień lub zakres (od–do). Propozycja pól: dziecko, powód, notatka.
      </p>

      <div class="form-grid">
        <div class="row">
          <div class="field">
            <label for="c-date">Data (pojedynczy dzień)</label>
            <input id="c-date" type="date" />
          </div>
          <div class="field">
            <label for="c-type">Typ dnia</label>
            <select id="c-type">
              <option value="1">Full day</option>
              <option value="0.5">Half day</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="c-child">Dziecko (opcjonalnie)</label>
            <input id="c-child" type="text" placeholder="np. Jan / Zosia" />
          </div>
          <div class="field">
            <label for="c-reason">Powód</label>
            <select id="c-reason">
              <option value="Choroba dziecka">Choroba dziecka</option>
              <option value="Opieka / przedszkole zamknięte">Opieka / przedszkole zamknięte</option>
              <option value="Wizyta lekarska dziecka">Wizyta lekarska dziecka</option>
              <option value="Inne">Inne</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="c-note">Notatka (opcjonalnie)</label>
          <input id="c-note" type="text" placeholder="np. gorączka, odbiór z przedszkola" />
        </div>

        <div class="actions">
          <button class="btn primary" id="c-add">Dodaj dzień</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="field">
            <label for="c-from">Zakres: od</label>
            <input id="c-from" type="date" />
          </div>
          <div class="field">
            <label for="c-to">Zakres: do</label>
            <input id="c-to" type="date" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="c-range-type">Typ dnia (dla całego zakresu)</label>
            <select id="c-range-type">
              <option value="1">Full day</option>
              <option value="0.5">Half day</option>
            </select>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn primary" id="c-add-range">Dodaj zakres</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn danger" id="c-clear">Wyczyść Child care</button>
        </div>
      </div>

      <div class="summary">
        <div class="pill">
          <strong>Wpisów</strong>
          <span class="accent" id="c-count">0</span>
        </div>
        <div class="pill">
          <strong>Łącznie dni</strong>
          <span id="c-total">0</span>
        </div>
        <div class="pill">
          <strong>Ostatnia data</strong>
          <span id="c-last">—</span>
        </div>
      </div>

      <div class="list" id="c-list"></div>
    </section>
  </div>

  <script>
    /**********************
     * Storage
     **********************/
    const STORAGE_KEY = "absence_tracker_v1";
    const STATE_VERSION = 1;

    const state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { version: STATE_VERSION, holidays: [], sickness: [], childcare: [] };
        const parsed = JSON.parse(raw);

        return {
          version: Number(parsed.version || STATE_VERSION),
          holidays: Array.isArray(parsed.holidays) ? parsed.holidays : [],
          sickness: Array.isArray(parsed.sickness) ? parsed.sickness : [],
          childcare: Array.isArray(parsed.childcare) ? parsed.childcare : []
        };
      }catch(e){
        return { version: STATE_VERSION, holidays: [], sickness: [], childcare: [] };
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function nextId(list){
      const max = list.reduce((m, x) => Math.max(m, Number(x.id || 0)), 0);
      return max + 1;
    }

    function safeNumber(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    function sumDays(list){
      return list.reduce((acc, item) => acc + safeNumber(item.dayValue), 0);
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Format daty + dzień tygodnia (EN jak w przykładzie)
    function fmtDateWithWeekday(iso){
      if(!iso) return "—";
      const [y,m,d] = iso.split("-");
      const dateObj = new Date(Number(y), Number(m) - 1, Number(d));
      const weekday = new Intl.DateTimeFormat("en-GB", { weekday: "long" }).format(dateObj);
      return `${d}.${m}.${y} • ${weekday}`;
    }

    function isoFromDate(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function enumerateDatesInclusive(fromIso, toIso){
      const [fy,fm,fd] = fromIso.split("-").map(Number);
      const [ty,tm,td] = toIso.split("-").map(Number);
      const start = new Date(fy, fm-1, fd);
      const end = new Date(ty, tm-1, td);

      if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return [];
      if (end < start) return [];

      const out = [];
      let cur = new Date(start);
      while(cur <= end){
        out.push(isoFromDate(cur));
        cur.setDate(cur.getDate() + 1);
      }
      return out;
    }

    /**********************
     * Tabs
     **********************/
    const tabs = document.querySelectorAll(".tab");
    const panels = {
      holidays: document.getElementById("panel-holidays"),
      sickness: document.getElementById("panel-sickness"),
      childcare: document.getElementById("panel-childcare")
    };

    tabs.forEach(btn => btn.addEventListener("click", () => activateTab(btn.dataset.tab)));

    function activateTab(key){
      tabs.forEach(t => {
        const active = (t.dataset.tab === key);
        t.classList.toggle("active", active);
        t.setAttribute("aria-selected", active ? "true" : "false");
      });
      Object.keys(panels).forEach(k => panels[k].classList.toggle("hidden", k !== key));
    }

    /**********************
     * Export / Import JSON
     **********************/
    const exportBtn = document.getElementById("export-json");
    const importBtn = document.getElementById("import-json");
    const resetAllBtn = document.getElementById("reset-all");
    const importFile = document.getElementById("import-file");

    exportBtn.addEventListener("click", () => {
      const payload = {
        exportedAt: new Date().toISOString(),
        ...state
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const ts = new Date();
      const stamp = `${ts.getFullYear()}-${String(ts.getMonth()+1).padStart(2,"0")}-${String(ts.getDate()).padStart(2,"0")}`;
      a.href = url;
      a.download = `absence-backup-${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", () => importFile.click());

    importFile.addEventListener("change", async () => {
      const file = importFile.files && importFile.files[0];
      importFile.value = "";
      if(!file) return;

      try{
        const text = await file.text();
        const parsed = JSON.parse(text);

        // minimalna walidacja
        const next = {
          version: Number(parsed.version || STATE_VERSION),
          holidays: Array.isArray(parsed.holidays) ? parsed.holidays : [],
          sickness: Array.isArray(parsed.sickness) ? parsed.sickness : [],
          childcare: Array.isArray(parsed.childcare) ? parsed.childcare : []
        };

        // sanity: każdy wpis powinien mieć date + id + dayValue (uzupełniamy jeśli braki)
        next.holidays = normalizeList(next.holidays);
        next.sickness = normalizeList(next.sickness);
        next.childcare = normalizeList(next.childcare);

        // nadpisz
        state.version = next.version;
        state.holidays = next.holidays;
        state.sickness = next.sickness;
        state.childcare = next.childcare;

        saveState();
        renderAll();
        alert("Import OK. Dane zostały wczytane.");
      }catch(e){
        alert("Nie udało się zaimportować pliku. Sprawdź, czy to poprawny JSON z eksportu.");
      }
    });

    resetAllBtn.addEventListener("click", () => {
      if(!confirm("Na pewno usunąć WSZYSTKIE dane (Holidays, Sickness, Child care)?")) return;
      state.holidays = [];
      state.sickness = [];
      state.childcare = [];
      saveState();
      renderAll();
    });

    function normalizeList(list){
      // uzupełnia brakujące pola i wyrównuje typy
      const out = [];
      for(const item of list){
        if(!item || typeof item !== "object") continue;
        if(!item.date) continue;

        const dayValue = safeNumber(item.dayValue);
        out.push({
          id: Number(item.id || 0) || 0,
          date: String(item.date),
          dayValue: dayValue || 1,
          dayType: item.dayType || ((dayValue || 1) === 1 ? "Full day" : "Half day"),
          note: item.note ? String(item.note) : "",
          cert: item.cert ? String(item.cert) : "",
          contact: item.contact ? String(item.contact) : "",
          child: item.child ? String(item.child) : "",
          reason: item.reason ? String(item.reason) : ""
        });
      }
      // jeśli id są 0, nadajemy świeże (stabilnie)
      let max = out.reduce((m,x)=>Math.max(m, Number(x.id||0)), 0);
      for(const x of out){
        if(!x.id || x.id <= 0){
          max += 1;
          x.id = max;
        }
      }
      return out;
    }

    /**********************
     * Generic add helpers
     **********************/
    function addSingle(listKey, entry){
      const list = state[listKey];

      if(list.some(x => x.date === entry.date)){
        return { ok:false, msg:`Ten dzień (${entry.date}) już istnieje w tej zakładce.` };
      }

      list.push({
        id: nextId(list),
        ...entry
      });
      return { ok:true };
    }

    function addRange(listKey, fromIso, toIso, entryBuilder){
      const dates = enumerateDatesInclusive(fromIso, toIso);
      if(dates.length === 0){
        return { ok:false, msg:"Niepoprawny zakres. Upewnij się, że 'od' <= 'do'." };
      }

      const list = state[listKey];
      const existing = new Set(list.map(x => x.date));
      const toAdd = dates.filter(d => !existing.has(d));

      if(toAdd.length === 0){
        return { ok:false, msg:"Wszystkie dni z tego zakresu już istnieją w tej zakładce." };
      }

      // dodajemy po kolei, każdy ma własne ID
      for(const d of toAdd){
        const entry = entryBuilder(d);
        list.push({ id: nextId(list), ...entry });
      }

      return { ok:true, added: toAdd.length, skipped: dates.length - toAdd.length };
    }

    /**********************
     * HOLIDAYS
     **********************/
    const HOLIDAYS_LIMIT = 25;

    const hDate = document.getElementById("h-date");
    const hType = document.getElementById("h-type");
    const hNote = document.getElementById("h-note");
    const hAdd = document.getElementById("h-add");
    const hClear = document.getElementById("h-clear");
    const hList = document.getElementById("h-list");

    const hFrom = document.getElementById("h-from");
    const hTo = document.getElementById("h-to");
    const hRangeType = document.getElementById("h-range-type");
    const hAddRange = document.getElementById("h-add-range");

    const hLimitEl = document.getElementById("h-limit");
    const hTakenEl = document.getElementById("h-taken");
    const hLeftEl = document.getElementById("h-left");

    hLimitEl.textContent = String(HOLIDAYS_LIMIT);

    hAdd.addEventListener("click", () => {
      const date = hDate.value;
      const dayValue = Number(hType.value);
      const note = (hNote.value || "").trim();

      if(!date){ alert("Wybierz datę."); return; }

      const taken = sumDays(state.holidays);
      if (HOLIDAYS_LIMIT - (taken + dayValue) < 0){
        alert("Przekraczasz limit Holidays (25 dni).");
        return;
      }

      const res = addSingle("holidays", {
        date,
        dayValue,
        dayType: dayValue === 1 ? "Full day" : "Half day",
        note
      });

      if(!res.ok){ alert(res.msg); return; }

      saveState();
      renderAll();

      hDate.value = "";
      hNote.value = "";
      hType.value = "1";
    });

    hAddRange.addEventListener("click", () => {
      const fromIso = hFrom.value;
      const toIso = hTo.value;
      const dayValue = Number(hRangeType.value);
      const note = (hNote.value || "").trim(); // ta sama notatka dla całego zakresu

      if(!fromIso || !toIso){
        alert("Uzupełnij daty 'od' i 'do'.");
        return;
      }

      const dates = enumerateDatesInclusive(fromIso, toIso);
      if(dates.length === 0){
        alert("Niepoprawny zakres (od <= do).");
        return;
      }

      // limit check z uwzględnieniem pominiętych duplikatów
      const existing = new Set(state.holidays.map(x => x.date));
      const toAddCount = dates.filter(d => !existing.has(d)).length;

      const taken = sumDays(state.holidays);
      const wouldAdd = toAddCount * dayValue;
      if(HOLIDAYS_LIMIT - (taken + wouldAdd) < 0){
        alert("Zakres przekroczy limit Holidays (25 dni). Usuń część dni albo użyj Half day.");
        return;
      }

      const res = addRange("holidays", fromIso, toIso, (d) => ({
        date: d,
        dayValue,
        dayType: dayValue === 1 ? "Full day" : "Half day",
        note
      }));

      if(!res.ok){ alert(res.msg); return; }

      saveState();
      renderAll();

      alert(`Dodano: ${res.added} dni. Pominięto (duplikaty): ${res.skipped}.`);

      hFrom.value = "";
      hTo.value = "";
      hRangeType.value = "1";
    });

    hClear.addEventListener("click", () => {
      if(!confirm("Na pewno wyczyścić wszystkie wpisy Holidays?")) return;
      state.holidays = [];
      saveState();
      renderAll();
    });

    function renderHolidays(){
      const taken = sumDays(state.holidays);
      const left = HOLIDAYS_LIMIT - taken;

      hTakenEl.textContent = String(taken % 1 === 0 ? taken.toFixed(0) : taken.toFixed(1));
      hLeftEl.textContent = String(left % 1 === 0 ? left.toFixed(0) : left.toFixed(1));
      hLeftEl.classList.toggle("bad", left <= 2);
      hLeftEl.classList.toggle("good", left > 2);

      const list = [...state.holidays].sort((a,b) => (a.date || "").localeCompare(b.date || ""));
      hList.innerHTML = "";

      if(list.length === 0){
        hList.innerHTML = `<div class="item"><div class="item-meta">Brak wpisów. Dodaj dzień lub zakres.</div></div>`;
        return;
      }

      list.forEach(item => {
        const el = document.createElement("div");
        el.className = "item";

        el.innerHTML = `
          <div class="item-top">
            <div class="item-title">ID ${item.id} • ${fmtDateWithWeekday(item.date)}</div>
            <div class="item-badge">${item.dayType}</div>
          </div>
          <div class="item-meta">
            <div><strong>Dni:</strong> ${item.dayValue}</div>
            ${item.note ? `<div><strong>Notatka:</strong> ${escapeHtml(item.note)}</div>` : ""}
          </div>
          <div class="item-actions">
            <button class="btn mini danger" data-action="delete" data-id="${item.id}">Usuń</button>
          </div>
        `;

        el.querySelector('[data-action="delete"]').addEventListener("click", () => {
          state.holidays = state.holidays.filter(x => x.id !== item.id);
          saveState();
          renderAll();
        });

        hList.appendChild(el);
      });
    }

    /**********************
     * SICKNESS
     **********************/
    const sDate = document.getElementById("s-date");
    const sType = document.getElementById("s-type");
    const sCert = document.getElementById("s-cert");
    const sContact = document.getElementById("s-contact");
    const sNote = document.getElementById("s-note");
    const sAdd = document.getElementById("s-add");
    const sClear = document.getElementById("s-clear");
    const sList = document.getElementById("s-list");

    const sFrom = document.getElementById("s-from");
    const sTo = document.getElementById("s-to");
    const sRangeType = document.getElementById("s-range-type");
    const sAddRange = document.getElementById("s-add-range");

    const sCountEl = document.getElementById("s-count");
    const sTotalEl = document.getElementById("s-total");
    const sLastEl = document.getElementById("s-last");

    sAdd.addEventListener("click", () => {
      const date = sDate.value;
      const dayValue = Number(sType.value);

      if(!date){ alert("Wybierz datę."); return; }

      const res = addSingle("sickness", {
        date,
        dayValue,
        dayType: dayValue === 1 ? "Full day" : "Half day",
        cert: sCert.value,
        contact: (sContact.value || "").trim(),
        note: (sNote.value || "").trim()
      });

      if(!res.ok){ alert(res.msg); return; }

      saveState();
      renderAll();

      sDate.value = "";
      sType.value = "1";
      sCert.value = "Nie";
      sContact.value = "";
      sNote.value = "";
    });

    sAddRange.addEventListener("click", () => {
      const fromIso = sFrom.value;
      const toIso = sTo.value;
      const dayValue = Number(sRangeType.value);

      if(!fromIso || !toIso){ alert("Uzupełnij daty 'od' i 'do'."); return; }

      const cert = sCert.value;
      const contact = (sContact.value || "").trim();
      const note = (sNote.value || "").trim();

      const res = addRange("sickness", fromIso, toIso, (d) => ({
        date: d,
        dayValue,
        dayType: dayValue === 1 ? "Full day" : "Half day",
        cert,
        contact,
        note
      }));

      if(!res.ok){ alert(res.msg); return; }

      saveState();
      renderAll();

      alert(`Dodano: ${res.added} dni. Pominięto (duplikaty): ${res.skipped}.`);

      sFrom.value = "";
      sTo.value = "";
      sRangeType.value = "1";
    });

    sClear.addEventListener("click", () => {
      if(!confirm("Na pewno wyczyścić wszystkie wpisy Sickness?")) return;
      state.sickness = [];
      saveState();
      renderAll();
    });

    function renderSickness(){
      const total = sumDays(state.sickness);
      const list = [...state.sickness].sort((a,b) => (a.date || "").localeCompare(b.date || ""));

      sCountEl.textContent = String(list.length);
      sTotalEl.textContent = String(total % 1 === 0 ? total.toFixed(0) : total.toFixed(1));
      sLastEl.textContent = list.length ? fmtDateWithWeekday(list[list.length - 1].date) : "—";

      sList.innerHTML = "";
      if(list.length === 0){
        sList.innerHTML = `<div class="item"><div class="item-meta">Brak wpisów. Dodaj dzień lub zakres.</div></div>`;
        return;
      }

      list.forEach(item => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-top">
            <div class="item-title">ID ${item.id} • ${fmtDateWithWeekday(item.date)}</div>
            <div class="item-badge">${item.dayType}</div>
          </div>
          <div class="item-meta">
            <div><strong>Dni:</strong> ${item.dayValue}</div>
            <div><strong>Zwolnienie:</strong> ${escapeHtml(item.cert || "Nie")}</div>
            ${item.contact ? `<div><strong>Info:</strong> ${escapeHtml(item.contact)}</div>` : ""}
            ${item.note ? `<div><strong>Notatka:</strong> ${escapeHtml(item.note)}</div>` : ""}
          </div>
          <div class="item-actions">
            <button class="btn mini danger" data-action="delete" data-id="${item.id}">Usuń</button>
          </div>
        `;

        el.querySelector('[data-action="delete"]').addEventListener("click", () => {
          state.sickness = state.sickness.filter(x => x.id !== item.id);
          saveState();
          renderAll();
        });

        sList.appendChild(el);
      });
    }

    /**********************
     * CHILD CARE
     **********************/
    const cDate = document.getElementById("c-date");
    const cType = document.getElementById("c-type");
    const cChild = document.getElementById("c-child");
    const cReason = document.getElementById("c-reason");
    const cNote = document.getElementById("c-note");
    const cAdd = document.getElementById("c-add");
    const cClear = document.getElementById("c-clear");
    const cList = document.getElementById("c-list");

    const cFrom = document.getElementById("c-from");
    const cTo = document.getElementById("c-to");
    const cRangeType = document.getElementById("c-range-type");
    const cAddRange = document.getElementById("c-add-range");

    const cCountEl = document.getElementById("c-count");
    const cTotalEl = document.getElementById("c-total");
    const cLastEl = document.getElementById("c-last");

    cAdd.addEventListener("click", () => {
      const date = cDate.value;
      const dayValue = Number(cType.value);

      if(!date){ alert("Wybierz datę."); return; }

      const res = addSingle("childcare", {
        date,
        dayValue,
        dayType: dayValue === 1 ? "Full day" : "Half day",
        child: (cChild.value || "").trim(),
        reason: cReason.value,
        note: (cNote.value || "").trim()
      });

      if(!res.ok){ alert(res.msg); return; }

      saveState();
      renderAll();

      cDate.value = "";
      cType.value = "1";
      cChild.value = "";
      cReason.value = "Choroba dziecka";
      cNote.value = "";
    });

    cAddRange.addEventListener("click", () => {
      const fromIso = cFrom.value;
      const toIso = cTo.value;
      const dayValue = Number(cRangeType.value);

      if(!fromIso || !toIso){ alert("Uzupełnij daty 'od' i 'do'."); return; }

      const child = (cChild.value || "").trim();
      const reason = cReason.value;
      const note = (cNote.value || "").trim();

      const res = addRange("childcare", fromIso, toIso, (d) => ({
        date: d,
        dayValue,
        dayType: dayValue === 1 ? "Full day" : "Half day",
        child,
        reason,
        note
      }));

      if(!res.ok){ alert(res.msg); return; }

      saveState();
      renderAll();

      alert(`Dodano: ${res.added} dni. Pominięto (duplikaty): ${res.skipped}.`);

      cFrom.value = "";
      cTo.value = "";
      cRangeType.value = "1";
    });

    cClear.addEventListener("click", () => {
      if(!confirm("Na pewno wyczyścić wszystkie wpisy Child care?")) return;
      state.childcare = [];
      saveState();
      renderAll();
    });

    function renderChildcare(){
      const total = sumDays(state.childcare);
      const list = [...state.childcare].sort((a,b) => (a.date || "").localeCompare(b.date || ""));

      cCountEl.textContent = String(list.length);
      cTotalEl.textContent = String(total % 1 === 0 ? total.toFixed(0) : total.toFixed(1));
      cLastEl.textContent = list.length ? fmtDateWithWeekday(list[list.length - 1].date) : "—";

      cList.innerHTML = "";
      if(list.length === 0){
        cList.innerHTML = `<div class="item"><div class="item-meta">Brak wpisów. Dodaj dzień lub zakres.</div></div>`;
        return;
      }

      list.forEach(item => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="item-top">
            <div class="item-title">ID ${item.id} • ${fmtDateWithWeekday(item.date)}</div>
            <div class="item-badge">${item.dayType}</div>
          </div>
          <div class="item-meta">
            <div><strong>Dni:</strong> ${item.dayValue}</div>
            ${item.child ? `<div><strong>Dziecko:</strong> ${escapeHtml(item.child)}</div>` : ""}
            <div><strong>Powód:</strong> ${escapeHtml(item.reason || "—")}</div>
            ${item.note ? `<div><strong>Notatka:</strong> ${escapeHtml(item.note)}</div>` : ""}
          </div>
          <div class="item-actions">
            <button class="btn mini danger" data-action="delete" data-id="${item.id}">Usuń</button>
          </div>
        `;

        el.querySelector('[data-action="delete"]').addEventListener("click", () => {
          state.childcare = state.childcare.filter(x => x.id !== item.id);
          saveState();
          renderAll();
        });

        cList.appendChild(el);
      });
    }

    function renderAll(){
      renderHolidays();
      renderSickness();
      renderChildcare();
    }

    (function init(){
      renderAll();
    })();

    /**********************
     * PWA: Service Worker
     * SW działa tylko na HTTPS lub localhost.
     **********************/
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }
  </script>
</body>
</html>